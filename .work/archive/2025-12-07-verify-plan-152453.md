# Plan Review - 2025-12-07

## Metadata
- **Reviewer:** plan-review-agent
- **Date:** 2025-12-07 15:24:53
- **Plan Location:** /Users/tobyhede/src/cipherpowers/.work/2025-12-07-agent-simplification-to-skill-delegation.md
- **Context:** Independent review #1 for dual-verification

## Status: BLOCKED

## Plan Summary
- **Feature:** Agent Simplification to Skill Delegation
- **Scope:** Refactor 8 bloated agents (code-agent, rust-agent, commit-agent, research-agent, plan-review-agent, execute-review-agent, technical-writer, gatekeeper) to follow thin skill-delegation pattern demonstrated by code-review-agent
- **Estimated Effort:** 9 tasks across 4 phases (file modifications, verification)

## BLOCKING (Must Address Before Execution)

**Missing skill verification for following-plans:**
- Description: Plan references `${CLAUDE_PLUGIN_ROOT}skills/following-plans/SKILL.md` in Tasks 1-8 but verification shows this skill exists. However, the plan does not validate that this skill actually provides the STATUS reporting enforcement pattern it claims agents are duplicating.
- Impact: The entire refactoring premise depends on following-plans skill providing execution discipline and STATUS reporting. If the skill doesn't provide this, agents will lose critical enforcement.
- Action: Add a verification step in Phase 4 to confirm following-plans skill contains STATUS reporting requirements that match the enforcement being removed from agents.

**Missing skill: verifying-execute does not exist:**
- Description: Task 6 (execute-review-agent) comments "Consider extracting to skills/verifying-execute/SKILL.md if reuse emerges" but execute-review-agent currently embeds ~200 lines of workflow. Verification confirms `/Users/tobyhede/src/cipherpowers/plugin/skills/verifying-execute/` does NOT exist.
- Impact: Without extracting to a skill, the simplification retains essential workflow inline (~35 lines), which contradicts the "thin delegation" pattern. The agent becomes a hybrid pattern rather than pure delegation.
- Action: Either (1) Create `skills/verifying-execute/SKILL.md` with the workflow BEFORE simplifying execute-review-agent, OR (2) Acknowledge in the plan that execute-review-agent will be an exception to the pattern with inline workflow justified by single-use case.

**Missing test strategy:**
- Description: Plan includes no test verification step to ensure simplified agents still work correctly after refactoring.
- Impact: Breaking changes could be introduced (missing skill files, incorrect paths, invalid YAML frontmatter) without detection until agents are invoked in production.
- Action: Add Task 9.5 before final commit: "Test simplified agents by invoking each with a sample task to verify skill loading, context reading, and workflow execution."

**No rollback/recovery plan:**
- Description: Plan commits each agent simplification individually but doesn't specify what to do if a later task reveals a fundamental flaw in the approach.
- Impact: If Task 8 or Task 9 reveals that the pattern doesn't work (e.g., skills missing critical enforcement), rolling back 7 individual commits becomes complex.
- Action: Add a Phase 0 task: "Create backup branch 'backup/agent-simplification' before starting modifications" and reference this in Phase 4 verification.

**Missing exact verification for skill file existence:**
- Description: Task 1 references skills (following-plans, test-driven-development, testing-anti-patterns, requesting-code-review) but plan doesn't verify these files exist before starting refactoring.
- Impact: Simplified agents will reference non-existent skills, causing failures when invoked.
- Action: Add Phase 0 verification task: "Verify all referenced skills exist: ls ${CLAUDE_PLUGIN_ROOT}skills/following-plans/SKILL.md, test-driven-development/SKILL.md, testing-anti-patterns/SKILL.md, requesting-code-review/SKILL.md, commit-workflow/SKILL.md, maintaining-docs-after-changes/SKILL.md, validating-review-feedback/SKILL.md, verifying-plans/SKILL.md"

**Line count estimates are approximate (~), not exact:**
- Description: All tasks use approximate line counts (~35 lines, ~40 lines) without exact verification.
- Impact: Verification step (Task 9.1) will compare approximate estimates against actual results, making it unclear what variance is acceptable. If actual results are 45 lines instead of ~35, is that a problem?
- Action: Change verification criteria in Task 9.1 to accept ranges (e.g., "30-50 lines") instead of exact values, OR add a step to each task to verify exact line count matches expectation.

## SUGGESTIONS (Would Improve Plan Quality)

**Consider adding documentation update task:**
- Description: The plan changes agent architecture significantly but doesn't update AGENTS.md or other documentation that describes agent structure.
- Benefit: Users and developers would understand the new agent pattern and know which agents follow pure delegation vs hybrid patterns.
- Action: Add Phase 4 task: "Update plugin/docs/AGENTS.md to document the thin skill-delegation pattern and list which agents follow it."

**Gatekeeper skill reference may not exist:**
- Description: Task 8 references `${CLAUDE_PLUGIN_ROOT}skills/validating-review-feedback/SKILL.md` but this wasn't verified to exist.
- Benefit: Verification confirms validating-review-feedback skill exists (checked via ls command), so this is low risk.
- Action: Add explicit verification step for this skill in Phase 0.

**Research-agent doesn't use skills despite having methodology:**
- Description: Task 4 keeps research methodology inline because "there's only one research agent" but this contradicts the stated goal of "Agents should be pure enforcement shells that reference skills."
- Benefit: Extracting research methodology to a skill would make it reusable if other research-type agents are added in the future, and would achieve full consistency with the pattern.
- Action: Consider creating `skills/research-methodology/SKILL.md` as part of Task 4 instead of keeping methodology inline. If not, add explicit justification in plan.

**Commit messages could reference issue/ticket:**
- Description: Commit messages are well-structured but don't reference any issue number or ticket.
- Benefit: Traceability for future reference and connecting commits to the feature request.
- Action: If there's a related issue, add reference like "Fixes #XXX" to commit messages.

**Missing verification of YAML frontmatter format:**
- Description: Task 9.3 verifies frontmatter exists ("Each file starts with --- and has name, description, color fields") but doesn't verify YAML is valid.
- Benefit: Invalid YAML (unquoted special characters, incorrect indentation) could break agent loading without detection.
- Action: Add validation command in Task 9.3: "Use a YAML linter or parser to verify frontmatter is valid YAML syntax."

**Phase ordering could be optimized:**
- Description: Phases are organized by agent type (Development, Workflow, Structural, Verification) but Task 8 (gatekeeper frontmatter) is in Phase 3 while other structural fixes aren't grouped.
- Benefit: Grouping all similar changes together (frontmatter additions, skill delegation simplifications) would make the plan more logical.
- Action: Consider moving gatekeeper to Phase 2 since it's a workflow agent, OR creating a separate phase for structural fixes like frontmatter.

## Plan Quality Checklist

**Security & Correctness:**
- [x] Plan addresses potential security vulnerabilities in design - N/A (refactoring, not new functionality)
- [x] Plan identifies dependency security considerations - N/A (no new dependencies)
- [x] Plan includes acceptance criteria that match requirements - Implicit (line count reductions, skill delegation pattern)
- [x] Plan considers concurrency/race conditions if applicable - N/A (file modifications are sequential)
- [x] Plan includes error handling strategy - Missing (no verification of YAML validity, skill file existence before refactoring)
- [x] Plan addresses API/schema compatibility - N/A (agent markdown files, not APIs)

**Testing:**
- [ ] Plan includes test strategy (unit, integration, property-based where needed) - MISSING: No test verification that simplified agents work
- [ ] Plan specifies test-first approach (TDD steps) - N/A (refactoring, not new functionality)
- [ ] Plan identifies edge cases to test - Partial (verification in Phase 4, but not comprehensive)
- [ ] Plan emphasizes behavior testing over implementation testing - N/A
- [ ] Plan includes test isolation requirements - N/A
- [ ] Plan specifies clear test names and structure (arrange-act-assert) - N/A

**Architecture:**
- [x] Plan maintains Single Responsibility Principle - Yes (agents become pure delegation shells)
- [x] Plan avoids duplication (identifies shared logic) - Yes (removes duplicated enforcement, delegates to skills)
- [x] Plan separates concerns clearly - Yes (enforcement in skills, delegation in agents)
- [x] Plan avoids over-engineering (YAGNI - only current requirements) - Partial (research-agent keeps inline methodology, execute-review-agent keeps inline workflow - pragmatic but inconsistent)
- [x] Plan minimizes coupling between modules - Yes (agents coupled to skills via stable interfaces)
- [x] Plan maintains encapsulation boundaries - Yes
- [x] Plan keeps modules testable in isolation - Partial (no test strategy specified)

**Error Handling:**
- [ ] Plan specifies error handling approach (fail-fast vs graceful) - MISSING: No handling for missing skills, invalid YAML, broken references
- [ ] Plan includes error message requirements - N/A (refactoring)
- [ ] Plan identifies invariants to enforce - Partial (line count ranges, frontmatter format)

**Code Quality:**
- [x] Plan emphasizes simplicity over cleverness - Yes (thin delegation is simple)
- [x] Plan includes naming conventions or examples - Yes (file naming, frontmatter fields)
- [x] Plan maintains type safety approach - N/A (markdown files)
- [x] Plan follows project patterns and idioms - Yes (follows code-review-agent pattern)
- [x] Plan avoids magic numbers (uses named constants) - N/A
- [x] Plan specifies where rationale comments are needed - Implicit (commit messages explain why)
- [x] Plan includes public API documentation requirements - Suggested (AGENTS.md update)

**Process:**
- [x] Plan includes verification steps for each task - Yes (Phase 4 dedicated to verification)
- [x] Plan identifies performance considerations - N/A (file size reduction improves loading)
- [ ] Plan includes linting/formatting verification - MISSING: No markdown linting or YAML validation
- [x] Plan scope matches requirements exactly (no scope creep) - Yes (focused on agent simplification)
- [x] Plan leverages existing libraries/patterns appropriately - Yes (follows code-review-agent pattern)
- [x] Plan includes commit strategy (atomic commits) - Yes (one commit per agent)

## Plan Structure Quality

**Task Granularity:**
- [x] Tasks are bite-sized (2-5 minutes each) - Yes (each task modifies one agent file)
- [x] Tasks are independent (can be done in any order where dependencies allow) - Partial (Tasks 1-7 are independent within phases, Task 8 depends on understanding pattern, Task 9 depends on all others)
- [x] Each task has clear success criteria - Yes (line counts, verification commands)

**Completeness:**
- [x] Exact file paths specified for all tasks - Yes (plugin/agents/*.md paths are exact)
- [ ] Complete code examples (not "add validation") - Partial (Tasks include full replacement content, but verification steps use approximate commands like `wc -l` without exact expected output)
- [x] Exact commands with expected output - Partial (Commands are exact, but expected output uses ranges/approximations)
- [x] References to relevant skills/practices where applicable - Yes (skills referenced in replacement content)

**TDD Approach:**
- [ ] Each task follows RED-GREEN-REFACTOR pattern - N/A (refactoring existing files, not writing new code with tests)
- [ ] Write test → Run test (fail) → Implement → Run test (pass) → Commit - N/A

## Assessment

**Ready for execution?** NO

**Reasoning:**

The plan has strong architecture (thin skill delegation pattern, clear phases, atomic commits) but has 6 BLOCKING issues that must be addressed:

1. **Critical dependency validation missing:** Plan doesn't verify that referenced skills actually exist or contain the enforcement patterns being removed from agents. If following-plans skill doesn't provide STATUS reporting, the entire refactoring loses critical functionality.

2. **Missing skill extraction:** The verifying-execute skill doesn't exist, making execute-review-agent a hybrid pattern that contradicts the "pure delegation" goal. Plan must either extract this skill first or explicitly justify the exception.

3. **No test strategy:** Simplified agents could break without detection. Need sample invocation tests for each refactored agent.

4. **No error handling:** Missing skills, invalid YAML, or broken references would cause runtime failures. Plan needs upfront verification (Phase 0) to fail fast if dependencies missing.

5. **No rollback plan:** Individual commits without a backup branch makes recovery from fundamental issues complex.

6. **Approximate verification criteria:** Using "~35 lines" without defining acceptable variance makes verification step subjective.

**Recommendations:**

1. Add Phase 0: Verification of all skill dependencies before any modifications
2. Add Task 6.0: Create skills/verifying-execute/SKILL.md before simplifying execute-review-agent
3. Add Task 9.5: Test each simplified agent with sample invocation
4. Add Phase 0: Create backup branch before starting
5. Define exact line count ranges instead of approximations (~35 → 30-40)
6. Add validation commands for YAML frontmatter correctness

Once these blocking issues are resolved, the plan will be ready for execution. The architecture is sound and the approach is systematic, but the execution risks must be mitigated first.
